<!DOCTYPE html>
<meta charset="UTF-8">
<html lang="en">

<head>
  <title>Proof of Liability</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.1/font/bootstrap-icons.css">
  <link href="index.css" rel="stylesheet">

  <style>
    .node text {
      font: 14px robot;
      fill: #fff;
      font-weight: bold;
    }

    .node text tspan {
      font-weight: normal;
    }

    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 2px;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="col"></div>

      <div class="col-11">
        <div class="row"></div>
        <h1 class="display-3">Proof of Liability <small class="text-muted">- Distributed Auditing</small></h1>
      </div>
      <div class="row">
        <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
          <button class="nav-link active" id="nav-desc-tab" data-bs-toggle="tab" data-bs-target="#nav-desc"
            type="button" role="tab" aria-controls="nav-desc" aria-selected="true">Description</button>
          <button class="nav-link" id="nav-data-tab" data-bs-toggle="tab" data-bs-target="#nav-data" type="button"
            role="tab" aria-controls="nav-data" aria-selected="true">Load Data</button>
          <button class="nav-link" id="nav-tree-tab" data-bs-toggle="tab" data-bs-target="#nav-tree" type="button"
            role="tab" aria-controls="nav-tree" aria-selected="false">Build Tree</button>
          <button class="nav-link" id="nav-verify-tab" data-bs-toggle="tab" data-bs-target="#nav-verify" type="button"
            role="tab" aria-controls="nav-verify" aria-selected="false">Verify Audit</button>
        </div>
      </div>
      <div class="row">
        <div class="card">
          <div class="card-body">
            <div class="tab-content" id="nav-tabContent">
              <div class="tab-pane fade show active" id="nav-desc" role="tabpanel" aria-labelledby="nav-desc-tab">
                <div class="row">
                  <h1 class="display-6 offset-md-1">Introduction</h1>
                </div>

                <div class="row">
                  <div class="col-md-9 offset-md-1">
                    <p>Proof of Liabilities (PoL) is a scheme designed to let companies that accept monetary deposits
                      from
                      consumers (e.g. Bitcoin exchanges, gambling websites, online Bitcoin wallets, etc.) prove their
                      total amount of deposits (their liabilities) without compromising the privacy of individual users.
                    </p>
                  </div>
                </div>


                <div class="row">
                  <h1 class="display-6 offset-md-1">How does it work?</h1>
                </div>

                <div class="row">
                  <div class="col-md-9 offset-md-1">
                    <ol>
                      <li class="mt-2"><strong>Build users data set</strong> - for each user we'll compute his
                        commitment as follow \(sha256(Id_{user} | balance_{user}) = commitment_{user}\).</li>
                      <li class="mt-2"><strong>Build a liability tree</strong> - based on the users' data set we'll
                        build a summation merkle tree.</li>
                      <li class="mt-2"><strong>The total liability</strong> - will be at the root of the tree. All leafs
                        will be sums up to the root. </li>
                      <li class="mt-2"><strong>Each user can verify</strong> that his liability were taken into account
                        by verify the path from his commitment at the leaf to the published root by Celsius.</li>
                    </ol>
                  </div>
                </div>

              </div>
              <div class="tab-pane fade" id="nav-data" role="tabpanel" aria-labelledby="nav-data-tab">
                <div class="row">
                  <h1 class="display-6 offset-md-1">Users table <small class="text-muted">(internal DB)</small> </h1>
                </div>
                <div class="row">

                  <div id="maintable-table" class="table-editable">
                    <table id='users_table'
                      class="table text-nowrap table-bordered table-sm table-responsive-md table-striped text-center">
                      <thead>
                        <tr>
                          <th class="text-center">User Id</th>
                          <th class="text-center">Balance</th>
                          <th class="text-center">Commitment</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td class="pt-3-half user-id" contenteditable="true">alice@celsius.network</td>
                          <td class="pt-3-half user-amount" contenteditable="true">30</td>
                          <td class="pt-3-half user-commitment">
                            f604ac9dd5566a447c0cddc8cd655e08080b3248d39243eddfc864f49b0bb280</td>
                          <td>
                            <span class="table-remove"><button type="button"
                                class="btn btn-danger btn-rounded btn-sm my-0">
                                Remove
                              </button></span>
                          </td>
                        </tr>
                        <!-- This is our clonable table line -->
                        <tr>
                          <td class="pt-3-half user-id" contenteditable="true">bob@celsius.network</td>
                          <td class="pt-3-half user-amount" contenteditable="true">45</td>
                          <td class="pt-3-half user-commitment">
                            ba4a44eb2d003799fa07a824f2004f195a4f6ea01dc2b20d130787c2a41ac926</td>
                          <td>
                            <span class="table-remove"><button type="button"
                                class="btn btn-danger btn-rounded btn-sm my-0">
                                Remove
                              </button></span>
                          </td>
                        </tr>
                        <!-- This is our clonable table line -->
                        <tr>
                          <td class="pt-3-half user-id" contenteditable="true">ron@celsius.network</td>
                          <td class="pt-3-half user-amount" contenteditable="true">3</td>
                          <td class="pt-3-half user-commitment">
                            a9264a3e5070c50b06c674f84a691c8ca1b1ae0be77bcc06c79551912a1c09da</td>
                          <td>
                            <span class="table-remove"><button type="button"
                                class="btn btn-danger btn-rounded btn-sm my-0">
                                Remove
                              </button></span>
                          </td>
                        </tr>
                        <!-- This is our clonable table line -->
                      </tbody>
                    </table>
                    <div class="row">
                      <div class="col-11"></div>
                      <div class="col-1"><button type="button" class="btn bottom-0 end-0 btn-primary"
                          id="btn-add-user">Add</button></div>
                    </div>
                  </div>


                </div>
                <div class="row">
                  <div id="users-table"></div>
                </div>
              </div>
              <div class="tab-pane fade" id="nav-tree" role="tabpanel" aria-labelledby="nav-tree-tab">
                <graph id='merkle-graph'></graph>
              </div>
              <div class="tab-pane fade" id="nav-verify" role="tabpanel" aria-labelledby="nav-verify-tab">

                <div class="row justify-content-center">
                  <h1 class="display-5 text-center">How to verify the audit?</h1>
                </div>

                <div class="row ">
                  <h4 class="display-6 offset-md-1"><u>Prover side</u></h4>
                </div>

                <div class="row offset-md-1">
                  <h5 class="display-7">Publish 3 things <i class="bi bi-broadcast-pin"></i></h5>
                </div>

                <div class="row offset-sm-1" style="padding-left: 30px;">
                  <ul>
                    <li>The merkle tree root (commitment + total liability)</li>
                    <li>A ZKP proof for the correctness of the tree</li>
                    <li>Send each user its own authentication path</li>
                  </ul>
                </div>

                <div class="row offset-md-1">
                  <p>In our case the root node value is <kbd
                      id="published-root-text">0eacb4896fa4a123c71dc111b96ff6d00ad654e5943075a250ec11ec50d40aac</kbd><br>
                    And the proof is <kbd>&#960</kbd></p>
                </div>

                <div class="row">
                  <div class="col-md-5 offset-md-1">
                    <h4 class="display-6"><u>Verifer side</u></h4>
                  </div>

                  <div class="col-md-2 offset-md-1 d-flex align-items-center">
                    <select id='user-verify-select' class="form-select"
                      onchange="if (this.selectedIndex) {let cmmt = computeCommitmentAndPopulate(this.value); updateGraphB(cmmt);}">
                      <!-- <option value="" disabled selected hidden>Choose a User</option> -->
                    </select>
                  </div>

                </div>

                <div class="row offset-md-1">
                  <h5 class="display-7">Compute its own commitment <i class="bi bi-pen"></i></h5>
                </div>


                <!-- <div class="row offset-md-1 mt-5">
                  <h3 style="font-weight: normal">Verifer compute his commitment <i class="bi bi-pen"></i></h3>
                </div> -->
                <!-- <div class="row offset-md-1">
                  <p>Select a user to compute his commitment</p>
                </div> -->

                <!-- <div class="row offset-md-1">
                  <div class="col-md-3">
                    <select id='user-verify-select' class="form-select"
                      onchange="if (this.selectedIndex) computeCommitment(this.value);">
                      <option value="" disabled selected hidden>Choose a User</option> 
                    </select>
                  </div>
                </div> -->

                <div class="row offset-md-1 mt-3" id="verify-commitment-compution">

                </div>

                <div class="row offset-md-1 mt-5">
                  <h5 class="display-7">Verifer checks if he have a path to the root node <i class="bi bi-search"></i>
                  </h5>
                </div>
                <div class="row offset-md-1">
                  <p>The prover provides each user an authentication path from his commitment to the liability tree's
                    root, which is the proof for including the verifier's liability within the total sum.</p>
                </div>

                <div class="row offset-md-1">
                  <graph-b id='merkle-graph-verifer'></graph-b>
                </div>


              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col"></div>
  </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"
    integrity="sha512-szJ5FSo9hEmXXe7b5AUVtn/WnL8a5VofnFeYC2i2z03uS2LhAch7ewNLbl5flsEmTTimMN0enBZg/3sQ+YOSzQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="start.js"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


  <script>


    function getNodeParnetOtherChild(node) {
      // let parent = d3.select('.node[node-name="'+ cmmt + '"]').datum().parent.data;
      let cmmt = node.data.commitment;
      let parent = node.parent.data;

      let firstChild = parent.children[0];
      let secondChild = parent.children[1];

      if (cmmt === firstChild.commitment) {
        return secondChild;
      } else {
        return firstChild;
      }
    }

    // function getNodeParent(cmmt) {
    //   return d3.select('.node[node-name="'+ cmmt + '"]').datum();  
    // }

    function expandAllNodesInVerifyGraph() {
      let rootCommitment = document.getElementById("published-root-text");

      let rootNode = d3.select('graph-b .node[node-name="'+ rootCommitment.innerText + '"]'); // .node().dispatchEvent(new Event('click'));
      
      // rescurisveExpand(rootNode);
      rescurisveExpand(rootNode.datum());
    }

    function rescurisveExpand(node) {
      console.log("recurisve iteration. Value:" + node.data.commitment);

      if (!node.children) {
        collapseNode(node.data.commitment);
      }

      if (node.children) {
        rescurisveExpand(node.children[0]);
        rescurisveExpand(node.children[1]);
      }

    }

    function collapseNode(cmmt) {
      d3.select('graph-b .node[node-name="'+ cmmt + '"]').node().dispatchEvent(new Event('click'));
    }

    function computeCommitmentAndPopulate(userId) {
      const trs = $('#users_table > tbody > tr');

      let isFound = false,
        commitment = '';
        amount = 0;

      for (i = 0; i < trs.length; i++) {
        let ele = $(trs[i])
        if (ele.find("td:eq(0)").text() == userId) {
          isFound = true;
          amount = ele.find("td:eq(1)").text();
          commitment = ele.find("td:eq(2)").text();
        }
      }

      if (isFound == true) {
        $('#verify-commitment-compution').html('');
        $('#verify-commitment-compution').append('<p id ="commitment-eq">\\(commitment_{user} = sha256(Id_{user} | balance_{user}) = sha256(' + userId + ' | ' + amount + ')\\)');
        $('#verify-commitment-compution').append('<p id ="commitment-eq-2">\\(commitment_{user} = ' + commitment + '\\)');

        MathJax.typeset(['#commitment-eq', '#commitment-eq-2']);
      } else {
        alert('error - cant find user name on the users table');
        return "";
      }

      return commitment;
    }

    function updateGraphB(cmmt) {

      console.log("expand graph before customize");
      expandAllNodesInVerifyGraph();

      console.log("input to update-graph-b: " + cmmt);
      let currNode = d3.select('.node[node-name="'+ cmmt + '"]').datum();

      console.log("currNode: " + currNode.data.commitment);

      // get the second and get father get t

      
      // while (d3.select('.node[node-name="e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855"]').datum().parent) {
        console.log("currNode.parnet: " + currNode.parent.data.commitment);


        while (currNode.parent) {
          // currNode = currNode.parent;
          // console.log("increment currNode to currNode.parent. value: " + currNode.data.commitment);

          console.log("getNodeParnetOtherChild. value: " + getNodeParnetOtherChild(currNode).commitment);

          console.log("trying to collapse with commitment: " + getNodeParnetOtherChild(currNode).commitment);

          collapseNode(getNodeParnetOtherChild(currNode).commitment);

          currNode = currNode.parent;
        }

    }

    const graphColor = ['#0E1766', '#710BC2', '#F63AAC', '#d281d2', '#7aa0cb', '#d281d2', '#000000', '#F6EBFF'];


    // $("#nav-tree-tab").click(function () {
    //   // table to array object
    //   var convertedIntoArray = [];
    //   $("table#users_table tbody tr").each(function () {
    //     var rowData = {};
    //     var actualData = $(this).find('td');
    //     if (actualData.length > 0) {
    //       actualData.each(function () {
    //         if ($(this).hasClass("user-id")) {
    //           rowData.userId = $(this).text();
    //         } else if ($(this).hasClass("user-amount")) {
    //           rowData.amount = Number($(this).text());
    //         } else if ($(this).hasClass("user-commitment")) {
    //           rowData.commitment = $(this).text();
    //         }
    //       });

    //       convertedIntoArray.push(rowData);
    //     }
    //   });

      
    //   let treeArr = buildTree(convertedIntoArray);

    //   updateVerifyPage(convertedIntoArray, treeArr);

    //   let diagramData = treeArrToTreeData(treeArr);

    //   buildDiagram(diagramData, "merkle-graph", "graph");

    //   buildDiagram(diagramData, "merkle-graph-verifer", "graph-b");
    // });

    // function updateVerifyPage(convertedIntoArray, treeArr){
    //   fillVerifyUserSelect(convertedIntoArray);
    //   updateVerficationRootValue(treeArr[0].commitment);

    // }

    // function fillVerifyUserSelect(usersArr) {
    //   var select = document.getElementById("user-verify-select"); 

    //   var i, L = select.options.length - 1;
    //   for (i = L; i >= 0; i--) {
    //     select.remove(i);
    //   }

    //   var el = document.createElement("option");
    //   el.textContent = "Choose a User";
    //   el.value = "";
    //   el.hidden = true;
    //   el.disabled = true;
    //   el.selected = true;
    //   select.appendChild(el);

    //   for (var i = 0; i < usersArr.length; i++) {
    //     var opt = usersArr[i].userId;
    //     el = document.createElement("option");
    //     el.textContent = opt;
    //     el.value = opt;
    //     select.appendChild(el);
    //   }
    // }

    // function updateVerficationRootValue(rootCommitment) {
    //   $('#published-root-text').text(rootCommitment);
    // }

    function buildTree(records) {

      // build leaf level 
      let leafLevelLength = 1;
      for (; leafLevelLength < records.length; leafLevelLength = leafLevelLength * 2) { }

      let leafLevel = [];

      for (let i = 0; i < leafLevelLength; i++) {

        if (i < records.length) {
          leafLevel.push({ commitment: records[i].commitment, amount: records[i].amount });
        } else {
          leafLevel.push({ commitment: sha256(""), amount: 0 });
        }
      }

      let levels = [];
      levels.push(leafLevel);

      let currLevel = leafLevel
      for (; currLevel.length > 1;) {

        let nextLevel = [];
        for (let i = 1; i < currLevel.length; i = i + 2) {
          let amountsSum = currLevel[i - 1].amount + currLevel[i].amount;
          let nextItem = { commitment: sha256(amountsSum + currLevel[i - 1].commitment + currLevel[i].commitment), amount: amountsSum };
          nextLevel.push(nextItem);
        }

        levels.push(nextLevel);
        currLevel = nextLevel;
      }

      let res = [];
      for (let i = levels.length; i >= 0; i--) {
        res.push.apply(res, levels[i]);
      }

      return res;
    }

    function treeArrToTreeData(array) {
      let level = 0;
      let idx = 1;
      let res = { name: array[idx - 1].amount.toString(), fill: graphColor[level], subname: shortHash(array[level].commitment), commitment: array[idx - 1].commitment };
      res.children = [];
      // left child

      let left = recursivee(idx + 1, level + 1, array);
      if (left) {
        res.children.push(left);
      }

      // right child
      let right = recursivee(idx + 2, level + 1, array);
      if (right) {
        res.children.push(right);
      }
      return res;
    }

    function recursivee(idx, level, array) {
      if (idx > array.length) {
        return "";
      }

      let res = { name: array[idx - 1].amount.toString(), fill: graphColor[level], subname: shortHash(array[idx - 1].commitment), commitment: array[idx - 1].commitment };
      res.children = [];

      // left child
      let left = recursivee(idx * 2, level + 1, array);
      if (left) {
        res.children.push(left);
      }

      // right child
      let right = recursivee((idx * 2) + 1, level + 1, array);
      if (right) {
        res.children.push(right);
      }

      return res;
    }

    function buildDiagram(treeData, deployToComponenetId, deployToComponenetType, isCollapsedAtInit) {
      const myNode = document.getElementById(deployToComponenetId);
      myNode.innerHTML = '';

      // Set the dimensions and margins of the diagram
      var margin = { top: 20, right: 90, bottom: 30, left: 90 },
        width = 960 - margin.left - margin.right,
        height = 700;

      // var svg = d3.select("graph").append("svg")
      var svg = d3.select(deployToComponenetType).append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate("
          + margin.left + "," + margin.top + ")");

      var i = 0,
        duration = 750,
        root;

      // declares a tree layout and assigns the size
      var treemap = d3.tree().size([height, width]);

      // Assigns parent, children, height, depth
      root = d3.hierarchy(treeData, function (d) { return d.children; });
      root.x0 = height / 2;
      root.y0 = 0;

      // Collapse after the second level
      if (isCollapsedAtInit == true) {
        root.children.forEach(collapse);
      }

      update(root);

      // Collapse the node and all it's children
      function collapse(d) {
        if (d.children) {
          d._children = d.children
          d._children.forEach(collapse)
          d.children = null
        }
      }

      function update(source) {

        // Assigns the x and y position for the nodes
        var treeData = treemap(root);

        // Compute the new tree layout.
        var nodes = treeData.descendants(),
          links = treeData.descendants().slice(1);

        // Normalize for fixed-depth.
        nodes.forEach(function (d) { d.y = d.depth * 180 });

        // Update the nodes...
        var node = svg.selectAll('g.node')
          .data(nodes, function (d) { return d.id || (d.id = ++i); });

        // Enter any new modes at the parent's previous position.
        var nodeEnter = node.enter().append('g')
          .attr('class', 'node')
          .attr("transform", function (d) {
            return "translate(" + source.x0 + "," + source.y0 + ")";
          })
          .on('click', click);

        var rectHeight = 60, rectWidth = 60;

        nodeEnter.append('rect')
          .on('click', click)
          .attr('class', 'node')
          .attr("width", rectWidth)
          .attr("height", rectHeight)
          .attr("x", 0)
          .attr("stroke", "grey")
          .attr("stroke-width", "2px")
          .attr("y", (rectHeight / 2) * -1)
          .attr("rx", "1")
          .attr('node-name', d => d.data.commitment.trim())
          .style("fill", function (d) {
            return d.data.fill;
          });


        // Add labels for the nodes
        nodeEnter.append('text')
          .attr("dy", "-.35em")
          .attr("x", function (d) {
            return 20;
          })
          .attr("text-anchor", function (d) {
            return "start";
          })
          .text(function (d) { return d.data.name; })
          .append("tspan")
          .attr("dy", "1.75em")
          .attr("x", function (d) {
            return 13;
          })
          .text(function (d) { return d.data.subname; }).attr("x", function (d) {
            return 4;
          });

        // UPDATE
        var nodeUpdate = nodeEnter.merge(node);

        // Transition to the proper position for the node
        nodeUpdate.transition()
          .duration(duration)
          .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
          });

        // Update the node attributes and style
        nodeUpdate.select('circle.node')
          .attr('r', 10)
          .style("fill", function (d) {
            return d._children ? "lightsteelblue" : "#fff";
          })
          .attr('cursor', 'pointer');


        // Remove any exiting nodes
        var nodeExit = node.exit().transition()
          .duration(duration)
          .attr("transform", function (d) {
            return "translate(" + source.x + "," + source.y + ")";
          })
          .remove();

        // On exit reduce the node circles size to 0
        nodeExit.select('circle')
          .attr('r', 1e-6);

        // On exit reduce the opacity of text labels
        nodeExit.select('text')
          .style('fill-opacity', 1e-6);

        // ****************** links section ***************************

        // Update the links...
        var link = svg.selectAll('path.link')
          .data(links, function (d) { return d.id; });

        // Enter any new links at the parent's previous position.
        var linkEnter = link.enter().insert('path', "g")
          .attr("class", "link")
          .attr('d', function (d) {
            var o = { x: source.x0, y: source.y0 }
            return diagonal(o, o)
          });

        // UPDATE
        var linkUpdate = linkEnter.merge(link);

        // Transition back to the parent element position
        linkUpdate.transition()
          .duration(duration)
          .attr('d', function (d) { return diagonal(d, d.parent) });

        // Remove any exiting links
        var linkExit = link.exit().transition()
          .duration(duration)
          .attr('d', function (d) {
            var o = { x: source.x, y: source.y }
            return diagonal(o, o)
          })
          .remove();

        // Store the old positions for transition.
        nodes.forEach(function (d) {
          d.x0 = d.x;
          d.y0 = d.y;
        });

        // Creates a curved (diagonal) path from parent to the child nodes
        function diagonal(s, d) {

          path = `M ${s.x + (rectWidth / 2)} ${s.y}
              C ${(s.x + d.x) / 2 + (rectWidth / 2)} ${s.y},
                ${(s.x + d.x) / 2 + (rectWidth / 2)} ${d.y},
                ${d.x + (rectWidth / 2)} ${d.y}`

          return path
        }

        // Toggle children on click.
        function click(d) {
          if (d.children) {
            d._children = d.children;
            d.children = null;
          } else {
            d.children = d._children;
            d._children = null;
          }
          update(d);
        }
      }
    }

    function shortHash(hash) {
      let trimmedHash = hash.trim();
      let first = trimmedHash.substring(0, 3);
      let last = trimmedHash.substring(trimmedHash.length - 3);
      let res = first + '...' + last;

      return res;
    }

  </script>

</body>

</html>